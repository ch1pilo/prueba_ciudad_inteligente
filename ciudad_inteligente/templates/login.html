{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>TrafficZone - Inicio de Sesión</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link rel="stylesheet" href="{% static 'css/styleLogin.css' %}">
</head>

<body>

  <header class="navbar">
    <div class="logo">TrafficZone</div>

    <nav class="nav-links" id="navLinks">
      <a href="{% url 'home' %}">INICIO</a>
      <a href="{% url 'rutas' %}" aria-label="login">Vista rutas</a>
      <a href="{% url 'login' %}" aria-label="login">Login</a>
    </nav>

    <button class="hamburger-icon" onclick="toggleMenu()">
      <i class="fas fa-bars"></i>
    </button>
  </header>

  <section class="login-hero">
    <div class="login-card">
      <div class="login-subtitle">BIENVENIDO AL</div>
      <h1 class="login-title">INICIO DE SESIÓN</h1>
      <form class="login-form" action="{% url 'logueo' %}" method="POST">
        {% csrf_token %}
        <div class="input-group">
          <i class="fas fa-user"></i>
          <input id="user" type="text" class="field" name="nombre" placeholder="Ingresa tu usuario" required>
        </div>
        <div class="input-group">
          <i class="fas fa-lock"></i>
          <input id="pass" type="password" name="pasword" class="field" placeholder="Ingresa tu contraseña" required>
          <i class="fas fa-eye icon-password" onclick="togglePassword()"></i>
        </div>
        <button type="submit" class="btn-primary">Acceder</button>
        <div class="login-footer">
          <p><a href="#" onclick="openFaceModal()">Ingresar con reconocimiento facial</a></p>
          <p><a href="#" onclick="openEmailModal()">Ingresar con correo electrónico</a></p>
        </div>
      </form>
    </div>
  </section>

  <div id="faceModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        Autenticación Facial
      </div>
      <div class="modal-body">
        <div style="text-align: center;">
          <div class="stage">
            <video id="inputVideo" autoplay playsinline muted
              style="max-width: 100%; background: #111; border-radius: 8px;"></video>
            <canvas id="overlay" style="position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>
          </div>
          <button class="btn-primary" id="captureUploadBtn" style="margin: 15px 0;">Tomar y verificar rostro</button>
          <div id="status"></div>
        </div>
        <button class="btn-close" onclick="closeFaceModal()">Cerrar</button>
      </div>
    </div>
  </div>
  <div id="emailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        Autenticación por Correo
      </div>
      <div class="modal-body">
        <form id="emailForm" onsubmit="submitEmailForm(event)">
          {% csrf_token %}
          <p>Ingresa tu correo electrónico para autenticarte:</p>
          <div class="input-group" style="margin: 20px 0;">
            <i class="fas fa-envelope"></i>
            <input type="email" name="correo" class="field" placeholder="correo@ejemplo.com" required>
          </div>
          <button type="submit" class="btn-primary">Enviar código</button>
        </form>
        <button class="btn-close" onclick="closeEmailModal()" style="margin-top: 15px;">Cerrar</button>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <script>
    // ===== ¡NUEVA FUNCIÓN PARA EL MENÚ! =====
    function toggleMenu() {
      const navLinks = document.getElementById('navLinks');
      navLinks.classList.toggle('show');
    }

    // ===== FUNCIONES BÁSICAS DEL LOGIN (Sin cambios) =====
    function togglePassword() {
      var passField = document.getElementById('pass');
      var icon = document.querySelector('.fa-eye');
      if (passField.type === "password") {
        passField.type = "text";
        icon.classList.replace('fa-eye', 'fa-eye-slash');
      } else {
        passField.type = "password";
        icon.classList.replace('fa-eye-slash', 'fa-eye');
      }
    }
    
    // ... (El resto de tus funciones JS: openFaceModal, openEmailModal, startCamera, syncCanvasToVideo, etc. van aquí sin cambios) ...
    function openFaceModal() {
      document.getElementById("faceModal").style.display = "flex";
      startCamera(); // Iniciar cámara al abrir modal
      event.preventDefault();
    }

    function openEmailModal() {
      document.getElementById("emailModal").style.display = "flex";
      event.preventDefault();
    }

    function closeFaceModal() {
      document.getElementById("faceModal").style.display = "none";
      stopCamera(); // Detener cámara al cerrar
    }

    function closeEmailModal() {
      document.getElementById("emailModal").style.display = "none";
    }

    async function submitEmailForm(event) {
      event.preventDefault();
      const formData = new FormData(event.target);

      try {
        const response = await fetch("{% url 'verificar_correo' %}", {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          }
        });

        const result = await response.json();
        if (result.success) {
          alert('Código enviado a tu correo. Revisa tu bandeja de entrada.');
          closeEmailModal();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error al enviar el correo');
      }
    }

    const video = document.getElementById('inputVideo');
    const canvas = document.getElementById('overlay');
    const statusDiv = document.getElementById('status');
    const captureUploadBtn = document.getElementById('captureUploadBtn');
    let stream = null;

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: 'user' },
          audio: false
        });
        video.srcObject = stream;
        video.addEventListener('loadedmetadata', () => {
          setTimeout(() => {
            initFaceRecognition();
          }, 650);
        });
      } catch (err) {
        alert("No se pudo iniciar la cámara: " + err.message);
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }
    }

    function syncCanvasToVideo() {
        const stage = video.parentElement;
        if (window.getComputedStyle(stage).position === 'static') {
            stage.style.position = 'relative';
        }
        const top = video.offsetTop;
        const left = video.offsetLeft;
        const width = video.clientWidth;
        const height = video.clientHeight;
        canvas.style.top = top + 'px';
        canvas.style.left = left + 'px';
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        canvas.width = width;
        canvas.height = height;
        return { width: width, height: height };
    }

    async function initFaceRecognition() {
      const MODEL_URL = '/static/models';
      await faceapi.loadSsdMobilenetv1Model(MODEL_URL);
      await faceapi.loadFaceLandmarkModel(MODEL_URL);
      await faceapi.loadFaceRecognitionModel(MODEL_URL);
      async function runDetection() {
        if (video.paused || video.ended) return setTimeout(runDetection, 200);
        const displaySize = syncCanvasToVideo();
        if (displaySize.width === 0 || displaySize.height === 0) {
            return setTimeout(runDetection, 100);
        }
        const detections = await faceapi.detectAllFaces(video)
          .withFaceLandmarks()
          .withFaceDescriptors();
        const resizedResults = faceapi.resizeResults(detections, displaySize);
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        faceapi.draw.drawFaceLandmarks(canvas, resizedResults);
        setTimeout(runDetection, 100);
      }
      runDetection();
    }

    function takeSnapshot() {
      const canvasTmp = document.createElement('canvas');
      const vw = video.videoWidth, vh = video.videoHeight;
      const ratio = vw && vh ? (vw / vh) : (640 / 480);
      canvasTmp.width = 640;
      canvasTmp.height = Math.round(640 / ratio);
      const ctx = canvasTmp.getContext('2d');
      ctx.drawImage(video, 0, 0, canvasTmp.width, canvasTmp.height);
      return canvasTmp.toDataURL('image/jpeg', 0.92);
    }

    async function captureAndUpload() {
      statusDiv.textContent = "Verificando rostro...";
      statusDiv.className = "loading";
      const dataUrl = takeSnapshot();
      const res = await fetch(dataUrl);
      const blob = await res.blob();
      const formData = new FormData();
      formData.append('photo', blob, 'captura.jpg');
      try {
        const response = await fetch('/upload-photo/', {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          }
        });
        const result = await response.json();
        if (result.autorizado) {
          statusDiv.textContent = "✅ Rostro verificado";
          setTimeout(() => {
            window.location.href = result.redirect_url;
          }, 1000);
        } else {
          statusDiv.textContent = "❌ Rostro no reconocido";
        }
      } catch (error) {
        statusDiv.textContent = "❌ Error de conexión";
      }
    }

    captureUploadBtn.addEventListener('click', captureAndUpload);

    window.addEventListener('click', function (event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
        stopCamera();
      }
    });
  </script>
</body>
</html>