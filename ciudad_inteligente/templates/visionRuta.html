{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Simulador TrafficZone - Estilo Popup</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="{% static 'css/styleinicio.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

    <style>
        #map {
            width: 100%;
            height: 100vh;
            z-index: 1;
        }


        /* --- Agrega esto al final de tu archivo CSS --- */

        /* Estilos base para el botón de hamburguesa (oculto en escritorio) */
        .hamburger-icon {
            display: none;
            background: none;
            border: none;
            color: #ffffff;
            /* Ajusta al color de tu texto */
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* MEDIA QUERY: Solo aplica cuando la pantalla es pequeña (celular/tablet) */
        @media (max-width: 768px) {

            /* 1. Mostrar el botón de hamburguesa */
            .hamburger-icon {
                display: block;
            }

            /* 2. Ocultar los enlaces por defecto en móvil */
            .nav-links {
                display: none;
                /* Oculto */
                width: 100%;
                flex-direction: column;
                background: rgba(0, 0, 0, 0.468) !important;
                text-align: center;
                position: absolute;
                top: 60px;
                /* Ajusta según la altura de tu navbar */
                left: 0;
                background-color: #fff;
                /* Color de fondo del menú desplegable */
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                padding: 20px 0;
                z-index: 1000;
                /* Para que quede por encima del contenido */
            }

            /* Estilo de los enlaces dentro del menú móvil */
            .nav-links a {
                display: block;
                margin: 10px 0;
            }

            /* 3. LA CLAVE: Mostrar el menú cuando tenga la clase 'show' */
            .nav-links.show {
                display: flex;
                /* ¡Aquí es donde ocurre la magia! */
            }
        }

        /* --- ESTILO NUEVO: Imitando al Popup de Leaflet --- */
        .leaflet-tooltip.popup-style {
            background-color: white;
            border: none;
            border-radius: 12px;
            /* Bordes redondeados como el popup standard */
            box-shadow: 0 3px 14px rgba(0, 0, 0, 0.4);
            /* Sombra suave */
            color: #333;
            font-family: "Helvetica Neue", Arial, Helvetica, sans-serif;
            font-size: 13px;
            font-weight: normal;
            padding: 8px 14px;
            margin-top: -10px;
            /* Ajuste de posición */
        }

        /* La flechita de abajo del tooltip para que sea blanca */
        .leaflet-tooltip-top.popup-style:before {
            border-top-color: white;
        }

        /* Texto interno destacado */
        .popup-content-title {
            font-weight: bold;
            margin-bottom: 2px;
            display: block;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <header class="navbar">
        <div class="logo">TrafficZone</div>

        <nav class="nav-links" id="navLinks">
            <a href="{% url 'home' %}">INICIO</a>
            <a href="{% url 'rutas' %}" aria-label="login">Vista rutas</a>
            <a href="{% url 'login' %}" aria-label="login">Login</a>
        </nav>

        <button class="hamburger-icon" onclick="toggleMenu()">
            <i class="fas fa-bars"></i>
        </button>
    </header>


    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

    <script>
        function toggleMenu() {
            const navLinks = document.querySelector('.nav-links');
            navLinks.classList.toggle('show');
        }
        // 1. CONFIGURACIÓN
        const map = L.map('map').setView([10.64, -71.61], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(map);

        const busIcon = L.icon({ iconUrl: "{% static 'img/bus.png' %}", iconSize: [42, 42], iconAnchor: [21, 42] });
        const paradaIcon = L.icon({ iconUrl: "{% static 'img/parada.png' %}", iconSize: [28, 28], iconAnchor: [14, 28] });

        // 2. FUNCIÓN DE ANIMACIÓN
        function animarBus(rutaCoords, listaParadas, color, onHalfway) {

            const marker = L.marker([rutaCoords[0][1], rutaCoords[0][0]], { icon: busIcon }).addTo(map);

            let i = 0;
            let enPausa = false;
            let ultimoStopId = null;

            const velocidadKmH = 60;
            const factorVelocidad = velocidadKmH / 3.6;
            const halfwayIndex = Math.floor(rutaCoords.length / 2);
            let halfwayTriggered = false;

            function mover() {
                if (i < rutaCoords.length - 1) {
                    const start = rutaCoords[i];
                    const end = rutaCoords[i + 1];

                    const ptStart = turf.point(start);
                    const ptEnd = turf.point(end);
                    const dist = turf.distance(ptStart, ptEnd, { units: 'meters' });

                    if (dist <= 0) { i++; mover(); return; }

                    const duracion = (dist / factorVelocidad) * 1000;
                    let inicio = null;

                    function paso(timestamp) {
                        if (enPausa) return;

                        if (!inicio) inicio = timestamp;
                        const progreso = (timestamp - inicio) / duracion;

                        if (progreso < 1) {
                            const currentPos = turf.along(turf.lineString([start, end]), progreso * dist, { units: 'meters' });
                            const [lng, lat] = currentPos.geometry.coordinates;

                            marker.setLatLng([lat, lng]);

                            // --- DETECCIÓN DE PARADA (AJUSTADO) ---
                            const busPoint = turf.point([lng, lat]);

                            const paradaCercana = listaParadas.find(p => {
                                // CAMBIO: Reducido a 10 metros para que se acerque más
                                return turf.distance(busPoint, p.geometry, { units: 'meters' }) < 10;
                            });

                            if (paradaCercana && ultimoStopId !== paradaCercana.id) {
                                enPausa = true;
                                ultimoStopId = paradaCercana.id;

                                // CAMBIO: Usamos la clase 'popup-style' y formato HTML limpio
                                marker.bindTooltip(`
                                    Esperando...
                                `, {
                                    permanent: true,
                                    direction: 'top',
                                    className: 'popup-style', // Clase CSS nueva
                                    offset: [0, -35] // Subimos un poco más el mensaje
                                }).openTooltip();

                                setTimeout(() => {
                                    marker.closeTooltip();
                                    marker.unbindTooltip();
                                    enPausa = false;
                                    inicio = performance.now() - (progreso * duracion);
                                    requestAnimationFrame(paso);
                                }, 3000);
                                return;
                            }
                            requestAnimationFrame(paso);
                        } else {
                            marker.setLatLng([end[1], end[0]]);
                            i++;

                            if (!halfwayTriggered && i >= halfwayIndex && onHalfway) {
                                halfwayTriggered = true;
                                onHalfway();
                            }
                            mover();
                        }
                    }
                    requestAnimationFrame(paso);
                } else {
                    i = 0;
                    ultimoStopId = null;
                    setTimeout(mover, 1000);
                }
            }
            mover();
        }

        // 3. INICIALIZACIÓN
        async function init() {
            const rutasConfig = [
                { url: "{% static 'rutas/capa_milagros.geojson' %}", color: "#2563eb" },
                { url: "{% static 'rutas/capa_delicias.geojson' %}", color: "#dc2626" },
                { url: "{% static 'rutas/capa_julio.geojson' %}", color: "#16a34a" }
            ];

            for (const conf of rutasConfig) {
                try {
                    const response = await fetch(conf.url);
                    const data = await response.json();

                    const rutaFeature = data.features.find(f => f.geometry.type === "LineString");
                    const paradasFeatures = data.features.filter(f => f.geometry.type === "Point");

                    if (rutaFeature) {
                        L.geoJSON(rutaFeature, {
                            style: { color: conf.color, weight: 5, opacity: 0.6 }
                        }).addTo(map);

                        L.geoJSON(paradasFeatures, {
                            pointToLayer: (feature, latlng) => L.marker(latlng, { icon: paradaIcon }),
                            onEachFeature: (feature, layer) => {
                                if (feature.properties && feature.properties.name) {
                                    layer.bindPopup(`<b>${feature.properties.name}</b>`);
                                }
                            }
                        }).addTo(map);

                        const coords = rutaFeature.geometry.coordinates;
                        const paradasParaLogica = paradasFeatures.map(f => ({
                            id: f.id || Math.random(),
                            geometry: turf.point(f.geometry.coordinates)
                        }));

                        const spawnBus2 = () => {
                            animarBus(coords, paradasParaLogica, conf.color, null);
                        };
                        animarBus(coords, paradasParaLogica, conf.color, spawnBus2);
                    }
                } catch (error) {
                    console.error(`Error cargando ${conf.url}:`, error);
                }
            }
        }

        init();
    </script>
</body>

</html>